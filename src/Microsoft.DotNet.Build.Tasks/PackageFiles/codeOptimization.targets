<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="ExtractZipFile" AssemblyFile="$(BuildToolsTaskDir)Microsoft.DotNet.Build.Tasks.dll"/>

  <PropertyGroup>
    <OptimizationDataToolsDir>$(ToolsDir)/OptimizationData</OptimizationDataToolsDir>
  </PropertyGroup>

  <!-- We should only run this target on Windows and only if EnableProfileGuidedOptimization is set and we have training data -->
  <Target Name="OptimizeWithTrainingData" AfterTargets="AfterBuild" BeforeTargets="CopyFilesToOutputDirectory"
          Condition="'$(OSEnvironment)'=='Windows_NT' and '$(EnableProfileGuidedOptimization)'=='true' and Exists('$(OptimizationDataToolsDir)/$(AssemblyName).zip')">

    <PropertyGroup>
      <IBCMergeToolPath>$(OptimizationDataToolsDir)/ibcmerge.exe</IBCMergeToolPath>
      <OptimizationDataForAssemblyDir>$(IntermediateOutputPath)/OptimizationData/$(AssemblyName)</OptimizationDataForAssemblyDir>
      <OptimizedAssemblyFile>$(IntermediateOutputPath)/OptimizedAssembly/$(AssemblyName).dll</OptimizedAssemblyFile>
    </PropertyGroup>

    <!-- Extract the profile data from the archive -->
    <ExtractZipFile SourceArchive="$(OptimizationDataToolsDir)/$(AssemblyName).zip"
                    DestinationDirectory="$(OptimizationDataForAssemblyDir)"
                    OverwriteDestination="true" />

    <!-- Copy the compiled assembly into a folder for further processing -->
    <MakeDir Directories="$(IntermediateOutputPath)/OptimizedAssembly" />
    <Message Text="Copy @(IntermediateAssembly) to $(IntermediateOutputPath)/OptimizedAssembly" />
    <Copy SourceFiles="@(IntermediateAssembly)" DestinationFolder="$(IntermediateOutputPath)/OptimizedAssembly" />

    <!-- Delete existing optimization data from the file that came from with the training data -->
    <Exec Command="$(IBCMergeToolPath) -f -delete -mo $(OptimizationDataForAssemblyDir)/$(AssemblyName).dll $(OptimizationDataForAssemblyDir)/$(AssemblyName).ibc" />

    <!-- Create ibc data for the new assembly -->
    <Exec Command="$(IBCMergeToolPath) -f -o $(IntermediateOutputPath)/OptimizedAssembly/$(AssemblyName).new.ibc -delete -mo $(OptimizedAssemblyFile) -incremental $(OptimizationDataForAssemblyDir)/$(AssemblyName).dll" />

    <!-- Compact the optimization data in the optimized assembly -->
    <Exec Command="$(IBCMergeToolPath) -minify -mu $(OptimizedAssemblyFile) -partialNGEN" />

    <!-- Verify that the optimization data has been applied -->
    <Exec Command="$(IBCMergeToolPath) -mi $(OptimizedAssemblyFile)" />

    <!-- We need to make sure that the assembly that gets packaged is the one with the optimization data -->
    <ItemGroup>
      <IntermediateAssembly Remove="@(IntermediateAssembly)"/>
      <IntermediateAssembly Include="$(IntermediateOutputPath)/OptimizedAssembly/$(AssemblyName).dll"/>
    </ItemGroup>
  </Target>
</Project>