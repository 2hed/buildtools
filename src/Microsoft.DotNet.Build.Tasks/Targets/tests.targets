<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="DiscoverTests">
    <ItemGroup>
      <TestAssemblies Include="$(TestWorkingDir)*.Tests\**\*.Tests.dll" Exclude="$(SkipTestAssemblies)" />
      <TestDirectories Include="@(TestAssemblies -> '%(RootDir)%(Directory)')" KeepDuplicates="false" />
    </ItemGroup>
  </Target>

  <Target Name="RunTests"
          DependsOnTargets="DiscoverTests"
          Inputs="@(TestDirectories)"
          Outputs="%(Identity)*.*"
          Condition="'$(SkipTests)' != 'True'">

    <ItemGroup>
      <!-- Batch directories, so we can run every directory in its own process.
           Run all test assemblies in the same directory in the same process. -->
      <ThisDirectoryAssemblies Include="%(TestDirectories.Identity)*.Tests.dll" />
    </ItemGroup>

    <!-- xUnit Traits -->
    <PropertyGroup>
      <ExcludeTraits Condition="'$(ExcludeTraits)'==''">category=outerloop;category=failing</ExcludeTraits>
    </PropertyGroup>
    <ItemGroup>
      <IncludeTraitsItems Include="$(IncludeTraits)" />
      <ExcludeTraitsItems Include="$(ExcludeTraits)" />
    </ItemGroup>
    
    <!-- Construct and invoke xunit console runner via corerun.exe -->
    <PropertyGroup>
      <XunitCommandLine>corerun.exe xunit.console.netcore.exe</XunitCommandLine>
      
      <XunitOptions Condition="'@(ThisDirectoryAssemblies)'!=''">$(XunitOptions) "%(ThisDirectoryAssemblies.Identity)" </XunitOptions>
      <XunitOptions Condition="'@(IncludeTraitsItems)'!=''">$(XunitOptions)-trait "%(IncludeTraitsItems.Identity)" </XunitOptions>
      <XunitOptions Condition="'@(ExcludeTraitsItems)'!=''">$(XunitOptions)-notrait "%(ExcludeTraitsItems.Identity)" </XunitOptions>
    </PropertyGroup>

    <Exec
      Command="$(XunitCommandLine) $(XunitOptions)"
      WorkingDirectory="%(TestDirectories.Identity)"
      ContinueOnError="ErrorAndContinue" />
  </Target>

</Project>
