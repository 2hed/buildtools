<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RunTestsForProject Condition="'$(RunTestsForProject)'=='' and '$(IsTestProject)'=='true'">true</RunTestsForProject>
    <RunTestsForProject Condition="'$(SkipTests)'=='true'">false</RunTestsForProject>
  </PropertyGroup>

  <!-- This is the target that copies the test assets to the test output -->
  <Import Project="$(MSBuildThisFileDirectory)publishtest.targets" />
  
  <!-- General xunit options -->
  <PropertyGroup>
    <XunitCommandLine>xunit.console.netcore.exe $(TargetFileName)</XunitCommandLine>
    <RunOuterLoop Condition="'$(RunOuterLoop)' == ''">false</RunOuterLoop>
    <XunitOptions Condition="'$(RunOuterLoop)'!='true'">$(XunitOptions) -notrait category=outerloop</XunitOptions>
    <XunitOptions>$(XunitOptions) -xml .\testResults.xml</XunitOptions>
    <XunitOptions>$(XunitOptions) -notrait category=failing</XunitOptions>
  </PropertyGroup>
  
  <!-- xUnit command line without coverage enabled -->
  <PropertyGroup>
    <XunitHost>corerun.exe</XunitHost>
    <TestHost>$(XunitHost)</TestHost>
    <TestCommandLine>$(XunitCommandLine) $(XunitOptions)</TestCommandLine>
  </PropertyGroup>

  <!-- The Code Coverage targets will override TestHost and TestCommandLine if coverage is enabled -->
  <Import Project="$(MSBuildThisFileDirectory)CodeCoverage.targets" />

  <!-- In VS (2015 Preview or later currently required): Debug to run unit tests on CoreCLR. -->
  <PropertyGroup Condition="'$(IsTestProject)'=='true'">
    <DebugTestFrameworkFolder>aspnetcore50</DebugTestFrameworkFolder>
    <StartWorkingDirectory Condition="'$(StartWorkingDirectory)' == ''">$(TestPath)$(DebugTestFrameworkFolder)</StartWorkingDirectory>
    <StartAction Condition="'$(StartAction)' == ''">Program</StartAction>
    <StartProgram Condition="'$(StartProgram)' == ''">$(StartWorkingDirectory)\$(TestHost)</StartProgram>
    <StartArguments Condition="'$(StartArguments)' == ''">$(TestCommandLine) -wait</StartArguments>
    <DebugEngines>{2E36F1D4-B23C-435D-AB41-18E608940038}</DebugEngines>
  </PropertyGroup>

  <!-- On command line run unit tests on CoreCLR after the Test target -->
  <Target Name="RunTestsForProject"
          AfterTargets="Test"
          Condition="'$(RunTestsForProject)'=='true'">

    <MakeDir Condition="'$(CoverageEnabledForProject)'=='true'" Directories="$(CoverageReportDir)" />

    <Exec Command="$(TestHost) $(TestCommandLine)"
          WorkingDirectory="$(TestPath)%(TestTargetFramework.Folder)"
          ContinueOnError="true">
      <Output PropertyName="TestRunExitCode" TaskParameter="ExitCode" />
    </Exec>

    <Error Condition="'$(TestRunExitCode)' != '0'" Text="One or more tests failed while running tests from '$(MSBuildProjectName)' please check log for details!" />
  </Target>
  
</Project>
